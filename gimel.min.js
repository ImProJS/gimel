/*! gimel 18-06-2014 */
"use strict";var gimel=function(){var a=function(){this.utils={setToInherit:function(a,b){return a.Parent=b,a.prototype=Object.create(b.prototype),a.prototype.constructor=a,a}},this.modules={};var a=function(a,b,c){this.name=a,this.dependencies=b,this.initializer=void 0===c?function(){}:c,this.extensions=[],this.autoDefined=!1};a.prototype.extend=function(a){this.extensions.push(a)};var b=function(b){var c,d=[];for(c in b)for(var e=b[c].dependencies,f=0,g=e.length;g>f;++f)b[e[f]]instanceof a||d.push(e[f]);return d},c=function(a){var b="",c={},d=0,e=[],f=[],g=0,h=0;for(b in a)c[b]=0;for(b in a)for(f=a[b].dependencies,g=0,h=f.length;h>g;++g)++c[f[g]];for(b in a)0===c[b]&&(e.push(b),++d);for(;0!==e.length;)for(b=e.shift(),f=a[b].dependencies,g=0,h=f.length;h>g;++g)0===--c[f[g]]&&(e.push(f[g]),++d);return Object.keys(a).length!==d},d=function(b,c,d){d="function"!=typeof d?function(){}:d;var e=new RegExp("^[a-zA-Z][a-zA-Z0-9_]*$");if(null===e.exec(b))console.error('Gimel::defineModule: the module name "'+b+'" must be alphanumeric and not begin with a digit');else{if(void 0===this[b])return this.modules[b]=new a(b,c,d),this.modules[b];console.error('Gimel::defineModule: the module name "'+b+'" is reserved')}};this.defineModule=function(b,c,e){var f=this.modules[b];return f instanceof a?f.autoDefined?(f.dependencies=c,f.initializer=e,f.autoDefined=!1,f):(console.error("Gimel::defineModule: the module "+b+" is already defined"),null):d.call(this,b,c,e)},this.module=function(b){var c=this.modules[b];return c instanceof a||(c=d.call(this,b,[]),c.autoDefined=!0),c};var e=function(){var a=b(this.modules),d=[],e=0,f=0,g=[];if(a.length>0)for(e=0,f=a.length;f>e;++e)console.error('Gimel::init: module "'+a[e]+'" is unknown');else if(c(this.modules))console.error("Gimel::init: module dependencies contain cycles");else{var h=[],i={};for(var j in this.modules){h.push(this.modules[j]);var k=this.modules[j].dependencies;i[j]=k.slice(0,k.length)}for(;0!==h.length;){var l=[];for(e=0;e<h.length;++e)g=i[h[e].name],0===g.length&&l.push(h.splice(e--,1)[0]);for(e=0,f=h.length;f>e;++e){g=i[h[e].name];for(var m=0,n=l.length;n>m;++m){var o=g.indexOf(l[m].name);o>-1&&g.splice(o,1)}}d=d.concat(l)}}return d};this.init=function(){for(var a=e.call(this),b=0,c=a.length;c>b;++b){var d=a[b];if(d.autoDefined&&console.warn("ImageTemplate: module "+d.name+" does not have explicit definition"),this[d.name]={},!d.initializer(this[d.name],d.extensions))for(var f=0,g=d.extensions.length;g>f;++f)d.extensions[f](this[d.name])}}};return new a}();gimel.module("imageTemplate").extend(function(){gimel.imageTemplate.extend(function(a){a.ImageView=function(a,b,c,d,e){this.image=a,this.x=b,this.y=c,this.width=d,this.height=e,this.dx=a.dx,this.dy=a.dy},a.ImageView.prototype.CHANNELS=a.prototype.CHANNELS,a.ImageView.prototype.DATA_TYPE=a.prototype.DATA_TYPE,a.prototype.getImageView=function(b,c,d,e){return new a.ImageView(this,b,c,d,e)}})}),gimel.defineModule("imageTemplate",[],function(a){a.dataTypes={Uint8ClampedT:Uint8ClampedArray,Uint8T:Uint8Array,Uint32T:Uint32Array,Int8T:Int8Array,Int32T:Int32Array,Float32T:Float32Array,Float64T:Float64Array},a.structures=[];var b=function(b,d){var e=function(a,c,e){this.width=a,this.height=c,this.data=new b(a*c*d),void 0!==e&&this.data.set(e),this.dx=d,this.dy=a*d,this.length=a*c*d};e.prototype.DATA_TYPE=c,e.prototype.CHANNELS=d,a.structures.push(e),gimel[c+d+"ChImage"]=e};a.extend=function(b){for(var c=0,d=a.structures.length;d>c;++c)b(a.structures[c],a.structures[c].prototype.DATA_TYPE,a.structures[c].prototype.CHANNELS)};for(var c in a.dataTypes)b(a.dataTypes[c],1),b(a.dataTypes[c],4);return!1}),gimel.module("imageTemplate").extend(function(){return gimel.imageTemplate.extend(function(a,b,c){1===c?(a.prototype.add=function(a){for(var b=this.data,c=a.data,d=0,e=a.length;e>d;++d)b[d]+=c[d];return this},a.prototype.subtract=function(a){for(var b=this.data,c=a.data,d=0,e=a.length;e>d;++d)b[d]-=c[d];return this},a.prototype.multiply=function(a){for(var b=this.data,c=a.data,d=0,e=a.length;e>d;++d)b[d]*=c[d];return this},a.prototype.divide=function(a){for(var b=this.data,c=a.data,d=0,e=a.length;e>d;++d)b[d]/=c[d];return this},a.prototype.square=function(){for(var a=this.data,b=(Math.sqrt,0),c=this.length;c>b;++b)a[b]*=a[b];return this},a.prototype.sqrt=function(){for(var a=this.data,b=Math.sqrt,c=0,d=this.length;d>c;++c)a[c]=b(a[c]);return this},a.prototype.normalize=function(a,b,c,d){for(var e=this.data,f=(d-c)/(b-a),g=0,h=this.length;h>g;++g)e[g]=(e[g]-a)*f+c;return this},a.prototype.min=function(a){for(var b=this.data,c=a.data,d=0,e=a.length;e>d;++d)b[d]=c[d]<b[d]?c[d]:b[d];return this},a.prototype.max=function(a){for(var b=this.data,c=a.data,d=0,e=a.length;e>d;++d)b[d]=c[d]>b[d]?c[d]:b[d];return this}):4===c&&(a.prototype.add=function(a){for(var b=this.data,c=a.data,d=0,e=a.length;e>d;d+=4)b[d]+=c[d],b[d+1]+=c[d+1],b[d+2]+=c[d+2];return this},a.prototype.subtract=function(a){for(var b=this.data,c=a.data,d=0,e=a.length;e>d;d+=4)b[d]-=c[d],b[d+1]-=c[d+1],b[d+2]-=c[d+2];return this},a.prototype.multiply=function(a){for(var b=this.data,c=a.data,d=0,e=a.length;e>d;d+=4)b[d]*=c[d],b[d+1]*=c[d+1],b[d+2]*=c[d+2];return this},a.prototype.divide=function(a){for(var b=this.data,c=a.data,d=0,e=a.length;e>d;d+=4)b[d]/=c[d],b[d+1]/=c[d+1],b[d+2]/=c[d+2];return this},a.prototype.square=function(){for(var a=this.data,b=(Math.sqrt,0),c=this.length;c>b;b+=4)a[b]*=a[b],a[b+1]*=a[b+1],a[b+2]*=a[b+2];return this},a.prototype.sqrt=function(){for(var a=this.data,b=Math.sqrt,c=0,d=this.length;d>c;c+=4)a[c]=b(a[c]),a[c+1]=b(a[c+1]),a[c+2]=b(a[c+2]);return this},a.prototype.normalize=function(a,b,c,d){for(var e=this.data,f=(d-c)/(b-a),g=0,h=this.length;h>g;g+=4)e[g]=(e[g]-a)*f+c,e[g+1]=(e[g+1]-a)*f+c,e[g+2]=(e[g+2]-a)*f+c;return this},a.prototype.min=function(a){for(var b=this.data,c=a.data,d=0,e=a.length;e>d;d+=4)b[d]=c[d]<b[d]?c[d]:b[d],b[d+1]=c[d+1]<b[d+1]?c[d+1]:b[d+1],b[d+2]=c[d+2]<b[d+2]?c[d+2]:b[d+2];return this},a.prototype.max=function(a){for(var b=this.data,c=a.data,d=0,e=a.length;e>d;d+=4)b[d]=c[d]>b[d]?c[d]:b[d],b[d+1]=c[d+1]>b[d+1]?c[d+1]:b[d+1],b[d+2]=c[d+2]>b[d+2]?c[d+2]:b[d+2];return this})}),!1}),gimel.module("imageTemplate").extend(function(){gimel.imageTemplate.extend(function(a,b,c){4===c&&(a.prototype.transformChannels=function(a){for(var b=a.data,c=this.data,d=0,e=this.length;e>d;d+=4){var f=c[d],g=c[d+1],h=c[d+2];c[d]=b[0]*f+b[1]*g+b[2]*h,c[d+1]=b[3]*f+b[4]*g+b[5]*h,c[d+2]=b[6]*f+b[7]*g+b[8]*h}return this},a.prototype.getChannel=function(b){for(var c=new a.T1ChImage(this.width,this.height),d=this.data,e=c.data,f=0,g=0,h=this.length;h>f;f+=4,++g)e[g]=d[f+b];return this},a.prototype.setChannel=function(b,c){for(var d=(new a.T1ChImage(this.width,this.height),this.data),e=c.data,f=0,g=0,h=this.length;h>f;f+=4,++g)d[f+b]=e[g];return this})})}),gimel.module("imageTemplate").extend(function(){return gimel.imageTemplate.extend(function(a){a.prototype.convolve=function(a,b){void(gimel.debug&&console.assert(1===a.CHANNELS,"AbstractImage::convolve: Mask must have just one channel")),void(gimel.debug&&console.assert(a.width===a.height,"AbstractImage::convolve: Mask must be square"));var c=this.cloneStructure(),d=c.data,e=this.data,f=0,g=0,h=0,i=a.width,j=a.height,k=a.width>>1,l=a.height>>1,m=this.dx,n=this.dy,o=this.width,p=this.height,q=o-k,r=p-l,s=0,t=0,u=0,v=0,w=0,x=0,y=0,z=0;for(v=0;j>v;++v)for(u=0;i>u;++u){for(y=a.data[v*a.width+u],x=0;l>x;++x)for(w=0;q>w;++w)s=w+u-k,t=x+v-l,h=w*m+x*n,f=(0>s?1-s:s)*m+(0>t?1-t:t)*n,d[h]+=e[f]*y,d[h+1]+=e[f+1]*y,d[h+2]+=e[f+2]*y;for(x=r;p>x;++x)for(w=0;q>w;++w)s=w+u-k,t=x+v-l,h=w*m+x*n,f=(0>s?1-s:s)*m+(p>t?t:2*p-t-1)*n,d[h]+=e[f]*y,d[h+1]+=e[f+1]*y,d[h+2]+=e[f+2]*y;for(x=l;r>x;++x)for(w=0;k>w;++w)s=w+u-k,t=x+v-l,h=w*m+x*n,f=(0>s?1-s:s)*m+(0>t?1-t:t)*n,d[h]+=e[f]*y,d[h+1]+=e[f+1]*y,d[h+2]+=e[f+2]*y;for(x=0;r>x;++x)for(w=q;o>w;++w)s=w+u-k,t=x+v-l,h=w*m+x*n,f=(o>s?s:2*o-s-1)*m+(0>t?1-t:t)*n,d[h]+=e[f]*y,d[h+1]+=e[f+1]*y,d[h+2]+=e[f+2]*y;for(x=r;p>x;++x)for(w=q;o>w;++w)s=w+u-k,t=x+v-l,h=w*m+x*n,f=(o>s?s:2*o-s-1)*m+(p>t?t:2*p-t-1)*n,d[h]+=e[f]*y,d[h+1]+=e[f+1]*y,d[h+2]+=e[f+2]*y}for(v=0;j>v;++v)for(u=0;i>u;++u)for(y=a.data[v*a.width+u],z=(u-k)*m+(v-l)*n,x=l;r>x;++x){var A=x*o;for(w=k;q>w;++w)f=4*(A+w),d[f]+=e[f+z]*y,d[f+1]+=e[f+z+1]*y,d[f+2]+=e[f+z+2]*y}if(b){var B=0;for(f=0,g=a.length;g>f;++f)B+=a.data[f];if(0!==B)for(f=0,g=this.length;g>f;f+=4)d[f]/=B,d[f+1]/=B,d[f+2]/=B}return c},a.prototype.gradient=function(){var a=new gimel.Int8T1ChImage(3,3,[0,-1,0,-1,0,1,0,1,0]);return this.convolve(a,!1)},a.prototype.gaussian=function(a){void(gimel.debug&&console.assert(1&a,"AbstractImage::gaussian: Size has to be odd")),void(gimel.debug&&console.assert(a>=3,"AbstractImage::gaussian: Size has to be at least 3"));var b;switch(a){case 3:b=new gimel.Float32T1ChImage(3,3,[.25,.5,.25,.5,1,.5,.25,.5,.25]);break;case 5:b=new gimel.Float32T1ChImage(5,5,[.07,.19,.26,.19,.07,.19,.55,.74,.55,.19,.26,.74,1,.74,.26,.19,.55,.74,.55,.19,.07,.19,.26,.19,.07]);break;case 7:b=new gimel.Float32T1ChImage(7,7,[.02,.08,.13,.16,.13,.08,.02,.08,.25,.42,.5,.42,.25,.08,.13,.42,.71,.84,.71,.42,.13,.16,.5,.84,1,.84,.5,.16,.13,.42,.71,.84,.71,.42,.13,.08,.25,.42,.5,.42,.25,.08,.02,.08,.13,.16,.13,.08,.02]);break;default:for(var c=a-1>>1,d=a+1>>1,e=[],f=1,g=d;g>f;f++)for(var h=1-f*f*(3*d-2*f)/(d*d*d),i=0,j=d;j>i;i++){var k=h*(1-i*i*(3*d-2*i)/(d*d*d));e[a*(c+i)+c+f]=k,e[a*(c-i)+c-f]=k,e[a*(c+f)+c-i]=k,e[a*(c-f)+c+i]=k}e[(a+1)*c]=1,b=new gimel.Float32T1ChImage(a,a,e)}return this.convolve(b,!0)}}),!1}),gimel.module("imageTemplate").extend(function(){return gimel.imageTemplate.extend(function(a){a.prototype.haar=function(){},a.prototype.fft=function(){}}),!1}),gimel.module("imageTemplate").extend(function(){gimel.imageTemplate.extend(function(a,b,c){1===c?(a.prototype.sum="Float32T"===b||"Float64T"===b?function(){for(var a=this.data,b=0,c=0,d=0,e=0,f=0,g=this.length;g>f;++f)e=a[f]-c,d=b+e,c=d-b,c-=e,b=d[f];return b}:function(){for(var a=this.data,b=0,c=0,d=this.length;d>c;++c)b+=a[c];return b},a.prototype.mean=function(){return this.sum()/this.length},a.prototype.median=function(){},a.prototype.variance=function(){for(var a=this.data,b=0,c=0,d=0,e=0,f=this.mean(),g=0,h=this.length;h>g;++g)d=a[g]-f,d*=d,e=d-c,d=b+e,c=d-b,c-=e,b=d;return b/this.length},a.prototype.meanSquaredError=function(){}):4===c&&(a.prototype.sum="Float32T"===b||"Float64T"===b?function(){for(var a=this.data,b=new Float64Array(4),c=new Float64Array(4),d=new Float64Array(4),e=new Float64Array(4),f=0,g=this.length;g>f;f+=4)e[0]=a[f]-c[0],d[0]=b[0]+e[0],c[0]=d[0]-b[0],c[0]-=e[0],b[0]=d[0],e[1]=a[f+1]-c[1],d[1]=b[1]+e[1],c[1]=d[1]-b[1],c[1]-=e[1],b[1]=d[1],e[2]=a[f+2]-c[2],d[2]=b[2]+e[2],c[2]=d[2]-b[2],c[2]-=e[2],b[2]=d[2];return b}:function(){var a,b=this.data;a=[0,0,0];for(var c=0,d=this.length;d>c;c+=4)a[0]+=b[c],a[1]+=b[c+1],a[2]+=b[c+2];return a},a.prototype.mean=function(){var a=this.sum();return[a[0]/this.length,a[1]/this.length,a[2]/this.length]},a.prototype.median=function(){},a.prototype.variance=function(){for(var a=this.data,b=new Float64Array(4),c=new Float64Array(4),d=new Float64Array(4),e=new Float64Array(4),f=this.mean(),g=0,h=this.length;h>g;g+=4)d[0]=a[g]-f[0],d[0]*=d[0],e[0]=d[0]-c[0],d[0]=b[0]+e[0],c[0]=d[0]-b[0],c[0]-=e[0],b[0]=d[0],d[1]=a[g+1]-f[1],d[1]*=d[1],e[1]=d[1]-c[1],d[1]=b[1]+e[1],c[1]=d[1]-b[1],c[1]-=e[1],b[1]=d[1],d[2]=a[g+2]-f[2],d[2]*=d[2],e[2]=d[2]-c[2],d[2]=b[2]+e[2],c[2]=d[2]-b[2],c[2]-=e[2],b[2]=d[2];return[b[0]/this.length,b[1]/this.length,b[2]/this.length]},a.prototype.meanSquaredError=function(){})})}),gimel.module("imageTemplate").extend(function(a){a.extend(function(a,b,c){4===c?a.prototype.T_1CH_IMAGE=gimel[b+"1ChImage"]:1===c&&(a.prototype.T_4CH_IMAGE=gimel[b+"4ChImage"]),a.prototype.clone=function(){return new a(this.width,this.height,this.data)},a.prototype.cloneStructure=function(){return new a(this.width,this.height)},a.prototype.from=function(b){for(var c=(new a(b.width,b.height),b.data),d=this.data,e=0,f=b.length;f>e;++e)d[e]=c[e];return this},a.prototype.set=function(a){return this.data.set(a.data),this},1===c?a.prototype.fill=function(a){for(var b=this.data,c=0,d=this.length;d>c;++c)b[c]=a;return this}:4===c&&(a.prototype.fill=function(a,b,c,d){for(var e=this.data,f=0,g=this.length;g>f;f+=4)e[f]=a,e[f+1]=b,e[f+2]=c,e[f+3]=d;return this},a.prototype.fillChannel=function(a,b){for(var c=this.data,d=0,e=this.length;e>d;d+=4)c[d+a]=b;return this},a.prototype.paste=function(){},a.prototype.pasteWithMask=function(){})})}),gimel.defineModule("io",["imageTemplate"],function(a){return gimel.CanvasImage=function(a,b,c){void 0===c&&(c=document.createElement("canvas"),c.width=imageDomElement.width,c.height=imageDomElement.height);var d=c.getContext("2d"),e=d.getImageData(0,0,c.width,c.height);gimel.Uint8ClampedT4ChImage.call(this,c.width,c.height,e.data),this.canvasData=e,this.canvasDomElement=c},gimel.utils.setToInherit(gimel.CanvasImage,gimel.Uint8ClampedT4ChImage),gimel.CanvasImage.prototype.updateCanvasData=function(){this.paintOnCanvas(this.canvasDomElement)},gimel.CanvasImage.prototype.paintOnCanvas=function(a){var b=a.getContext("2d");this.canvasData.data.set(this.data),b.putImageData(this.canvasData,0,0)},a.imageFromDomCanvas=function(a){return new gimel.CanvasImage(a.width,a.height,a)},a.imageFromDomImage=function(b){var c=document.createElement("canvas");c.width=b.width,c.height=b.height;var d=c.getContext("2d");return d.drawImage(b,0,0),a.imageFromDomCanvas(c)},a.imageFromFile=function(b,c){var d=new Image;d.addEventListener("load",function(){var b=a.imageFromDomImage(d);c(b)},!1),d.src=b},a.imageToDataURL=function(a){var b;return a instanceof gimel.CanvasImage?b=a:(b=new gimel.CanvasImage(a.width,a.height),a instanceof gimel.Uint8ClampedT4ChImage||a instanceof gimel.Uint8T4ChImage?b.set(a):b.from(a)),b.updateCanvasData(),b.canvasDomElement.toDataURL("image/png")},a.imageToDomImage=function(b){var c=new Image;return c.src=a.imageToDataURL(b),c},!1});