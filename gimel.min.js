/*! gimel 08-06-2014 */
"use strict";var gimel=function(){var a=function(){this.utils={setInheritance:function(a,b){return a.Parent=b,a.prototype=Object.create(b.prototype),a.prototype.constructor=a,a}},this.modules={};var a=function(a,b,c){this.name=a,this.dependencies=b,this.initializer=void 0===c?function(){}:c,this.extensions=[],this.autoDefined=!1};a.prototype.extend=function(a){this.extensions.push(a)};var b=function(b){var c,d=[];for(c in b)for(var e=b[c].dependencies,f=0,g=e.length;g>f;++f)b[e[f]]instanceof a||d.push(e[f]);return d},c=function(a){var b,c={},d=0,e=[];for(b in a)c[b]=0;for(b in a)for(var f=a[b].dependencies,g=0,h=f.length;h>g;++g)++c[f[g]];for(b in a)0===c[b]&&(e.push(b),++d);for(;0!==e.length;){b=e.shift();for(var f=a[b].dependencies,g=0,h=f.length;h>g;++g)0===--c[f[g]]&&(e.push(f[g]),++d)}return Object.keys(a).length!==d},d=function(b,c,d){d="function"!=typeof d?function(){}:d;var e=new RegExp("^[a-zA-Z][a-zA-Z0-9_]*$");if(null===e.exec(b))console.error('Gimel::defineModule: the module name "'+b+'" must be alphanumeric and not begin with a digit');else{if(void 0===this[b])return this.modules[b]=new a(b,c,d),this.modules[b];console.error('Gimel::defineModule: the module name "'+b+'" is reserved')}};this.defineModule=function(b,c,e){var f=this.modules[b];return f instanceof a?f.autoDefined?(f.dependencies=c,f.initializer=e,f.autoDefined=!1,f):(console.error("Gimel::defineModule: the module "+b+" is already defined"),null):d.call(this,b,c,e)},this.module=function(b){var c=this.modules[b];return c instanceof a||(c=d.call(this,b,[]),c.autoDefined=!0),c};var e=function(){var a=b(this.modules),d=[];if(a.length>0)for(var e=0,f=a.length;f>e;++e)console.error('Gimel::init: module "'+a[e]+'" is unknown');else if(c(this.modules))console.error("Gimel::init: module dependencies contain cycles");else{var g=[],h={};for(var i in this.modules){g.push(this.modules[i]);var j=this.modules[i].dependencies;h[i]=j.slice(0,j.length)}for(;0!==g.length;){for(var k=[],e=0;e<g.length;++e){var l=h[g[e].name];0===l.length&&k.push(g.splice(e--,1)[0])}for(var e=0,f=g.length;f>e;++e)for(var l=h[g[e].name],m=0,n=k.length;n>m;++m){var o=l.indexOf(k[m].name);o>-1&&l.splice(o,1)}d=d.concat(k)}}return d};this.init=function(){for(var a=e.call(this),b=0,c=a.length;c>b;++b){var d=a[b];if(d.autoDefined&&console.warn("ImageTemplate: module "+d.name+" does not have explicit definition"),this[d.name]={},!d.initializer(this[d.name],d.extensions))for(var f=0,g=d.extensions.length;g>f;++f)d.extensions[f](this[d.name])}}};return new a}(this);gimel.defineModule("imageTemplate",[],function(a){a.dataTypes={Uint8ClampedT:Uint8ClampedArray,Uint8T:Uint8Array,Uint32T:Uint32Array,Int8T:Int8Array,Int32T:Int32Array,Float32T:Float32Array,Float64T:Float64Array},a.structures=[];var b=function(b,d){var e=function(a,c,e){this.width=a,this.height=c,this.data=new b(a*c*d),void 0!==e&&this.data.set(e),this.dx=d,this.dy=a*d,this.length=a*c*d};a.structures.push(e),gimel[c+d+"ChImage"]=e};a.extend=function(b){for(var c=0,d=a.structures.length;d>c;++c)b(a.structures[c])};for(var c in a.dataTypes)b(a.dataTypes[c],1),b(a.dataTypes[c],4);return!1}),gimel.module("imageTemplate").extend(function(){return gimel.imageTemplate.extend(function(a){a.prototype.add=function(a){for(var b=this.data,c=a.data,d=0,e=a.length;e>d;d+=4)b[d]+=c[d],b[d+1]+=c[d+1],b[d+2]+=c[d+2];return this},a.prototype.subtract=function(a){for(var b=this.data,c=a.data,d=0,e=a.length;e>d;d+=4)b[d]-=c[d],b[d+1]-=c[d+1],b[d+2]-=c[d+2];return this},a.prototype.divide=function(a){for(var b=this.data,c=a.data,d=0,e=a.length;e>d;d+=4)b[d]/=c[d],b[d+1]/=c[d+1],b[d+2]/=c[d+2];return this},a.prototype.square=function(){for(var a=this.data,b=(Math.sqrt,0),c=this.length;c>b;b+=4)a[b]=a[b]*a[b],a[b+1]=a[b+1]*a[b+1],a[b+2]=a[b+2]*a[b+2];return this},a.prototype.sqrt=function(){for(var a=this.data,b=Math.sqrt,c=0,d=this.length;d>c;c+=4)a[c]=b(a[c]),a[c+1]=b(a[c+1]),a[c+2]=b(a[c+2]);return this},a.prototype.normalize=function(a,b,c,d){for(var e=this.data,f=(d-c)/(b-a),g=0,h=this.length;h>g;g+=4)e[g]=(e[g]-a)*f+c,e[g+1]=(e[g+1]-a)*f+c,e[g+2]=(e[g+2]-a)*f+c;return this},a.prototype.min=function(a){for(var b=this.data,c=a.data,d=0,e=a.length;e>d;d+=4)b[d]=c[d]<b[d]?c[d]:b[d],b[d]=c[d+1]<b[d+1]?c[d+1]:b[d+1],b[d]=c[d+2]<b[d+2]?c[d+2]:b[d+2];return this},a.prototype.max=function(a){for(var b=this.data,c=a.data,d=0,e=a.length;e>d;d+=4)b[d]=c[d]>b[d]?c[d]:b[d],b[d]=c[d+1]>b[d+1]?c[d+1]:b[d+1],b[d]=c[d+2]>b[d+2]?c[d+2]:b[d+2];return this}}),!1}),gimel.module("imageTemplate").extend(function(){return gimel.imageTemplate.extend(function(a){a.prototype.transformChannels=function(a){for(var b=a.data,c=this.data,d=0,e=this.length;e>d;d+=4){var f=c[d],g=c[d+1],h=c[d+2];c[d]=b[0]*f+b[1]*g+b[2]*h,c[d+1]=b[3]*f+b[4]*g+b[5]*h,c[d+2]=b[6]*f+b[7]*g+b[8]*h}return this}}),!1}),gimel.module("imageTemplate").extend(function(a){a.extend(function(a){a.prototype.clone=function(){return new a(this.width,this.height,this.data)},a.prototype.from=function(b){for(var c=(new a(b.width,b.height),b.data),d=this.data,e=0,f=b.length;f>e;++e)d[e]=c[e];return this},a.prototype.set=function(a){return this.data.set(a.data),this}})}),gimel.defineModule("io",["imageTemplate"],function(a){return gimel.CanvasImage=function(a,b,c){void 0===c&&(c=document.createElement("canvas"),c.width=imageDomElement.width,c.height=imageDomElement.height);var d=c.getContext("2d"),e=d.getImageData(0,0,c.width,c.height);gimel.Uint8ClampedT4ChImage.call(this,c.width,c.height,e.data),this.canvasData=e,this.canvasDomElement=c},gimel.utils.setInheritance(gimel.CanvasImage,gimel.Uint8ClampedT4ChImage),gimel.CanvasImage.prototype.paintOnCanvas=function(a){var b=a.getContext("2d");this.canvasData.data.set(this.data),b.putImageData(this.canvasData,0,0)},a.imageFromDomCanvas=function(a){return new gimel.CanvasImage(a.width,a.height,a)},a.imageFromDomImage=function(b){var c=document.createElement("canvas");c.width=b.width,c.height=b.height;var d=c.getContext("2d");return d.drawImage(b,0,0),a.imageFromDomCanvas(c)},a.imageFromFile=function(b,c){var d=new Image;d.addEventListener("load",function(){var b=a.imageFromDomImage(d);c(b)},!1),d.src=b},a.imageToDomImage=function(a){if(!(a instanceof gimel.CanvasImage)){var b=new gimel.CanvasImage(a.width,a.height);a instanceof gimel.Uint8ClampedT4ChImage||a instanceof gimel.Uint8T4ChImage?b.set(a):b.from(a)}var c=new Image;return c.src=a.canvasDomElement.toDataURL("image/png"),c},!1});